<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matchflix</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Segoe UI', sans-serif;
      background: #000000;
      color: #f5f5f7;
      min-height: 100vh;
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 3rem;
    }

    h1 {
      font-size: 3.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ffffff 0%, #a0a0a0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }

    .tagline {
      font-size: 1.1rem;
      color: #86868b;
      font-weight: 400;
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0071e3, #005bb5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.2rem;
    }

    .btn {
      padding: 0.6rem 1.25rem;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.08);
      color: #f5f5f7;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: #0071e3;
      border-color: #0071e3;
      color: white;
    }

    .btn-primary:hover {
      background: #005bb5;
      border-color: #005bb5;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .search-container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto 1rem;
    }

    .search-bar {
      width: 100%;
      padding: 0.875rem 1.25rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      color: #f5f5f7;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-bar::placeholder {
      color: #86868b;
    }

    .search-bar:focus {
      outline: none;
      border-color: #0071e3;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .control-group {
      display: flex;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.08);
      padding: 0.5rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .control-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      color: #f5f5f7;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .control-btn.active {
      background: #0071e3;
      color: white;
      font-weight: 600;
    }

    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 2rem;
    }

    .content-card {
      background: rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.4s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .content-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .content-card.matched {
      border: 1px solid #0071e3;
      background: rgba(0, 113, 227, 0.1);
      box-shadow: 0 8px 25px rgba(0, 113, 227, 0.2);
    }

    .poster-container {
      position: relative;
      aspect-ratio: 2/3;
      background: rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .poster {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.4s ease;
    }

    .content-card:hover .poster {
      transform: scale(1.05);
    }

    .poster-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.3);
      font-size: 3rem;
    }

    .match-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #0071e3;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .content-info {
      padding: 1.25rem;
    }

    .content-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #f5f5f7;
      line-height: 1.3;
      letter-spacing: -0.01em;
    }

    .content-meta {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #86868b;
    }

    .rating {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: #f5a623;
    }

    .content-description {
      font-size: 0.9rem;
      line-height: 1.5;
      color: #86868b;
      margin-bottom: 1rem;
    }

    .streaming-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .streaming-badge {
      padding: 0.35rem 0.75rem;
      background: rgba(0, 113, 227, 0.15);
      border: 1px solid rgba(0, 113, 227, 0.3);
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #0071e3;
    }

    .trailer-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #f5f5f7;
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .trailer-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .rating-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .rating-btn {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.08);
      color: #f5f5f7;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .rating-btn:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.12);
    }

    .rating-btn.interested.active {
      background: #0071e3;
      border-color: #0071e3;
      color: white;
    }

    .rating-btn.not-interested.active {
      background: rgba(134, 134, 139, 0.3);
      border-color: rgba(134, 134, 139, 0.5);
      color: #86868b;
    }

    .rating-btn.remove-btn {
      background: rgba(255, 59, 48, 0.1);
      border-color: rgba(255, 59, 48, 0.3);
      color: #ff3b30;
    }

    .rating-btn.remove-btn:hover {
      background: rgba(255, 59, 48, 0.2);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #1c1c1e;
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header {
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }

    .modal-header p {
      color: #86868b;
      font-size: 0.95rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #f5f5f7;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .form-control {
      width: 100%;
      padding: 0.875rem 1rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      color: #f5f5f7;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #0071e3;
      background: rgba(255, 255, 255, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .form-actions .btn {
      flex: 1;
    }

    .form-toggle {
      text-align: center;
      margin-top: 1rem;
      color: #86868b;
      font-size: 0.9rem;
    }

    .form-toggle a {
      color: #0071e3;
      text-decoration: none;
      font-weight: 500;
    }

    .form-toggle a:hover {
      text-decoration: underline;
    }

    .error-message {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid rgba(255, 59, 48, 0.3);
      color: #ff3b30;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      white-space: pre-line;
    }

    .success-message {
      background: rgba(48, 209, 88, 0.1);
      border: 1px solid rgba(48, 209, 88, 0.3);
      color: #30d158;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .loading {
      text-align: center;
      padding: 4rem 2rem;
      font-size: 1.2rem;
      color: #86868b;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #86868b;
    }

    .empty-state h3 {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #f5f5f7;
      font-weight: 600;
    }

    .hidden {
      display: none !important;
    }

    /* Friend Management Styles */
    .friend-section {
      background: rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .friend-section h3 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: #f5f5f7;
    }

    .friend-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .friend-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .friend-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .friend-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0071e3, #005bb5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .friend-details {
      display: flex;
      flex-direction: column;
    }

    .friend-name {
      font-weight: 600;
      color: #f5f5f7;
    }

    .friend-username {
      font-size: 0.85rem;
      color: #86868b;
    }

    .friend-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.5rem 0.875rem;
      font-size: 0.85rem;
    }

    .friend-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .friend-chip {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .friend-chip:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .friend-chip.selected {
      background: #0071e3;
      border-color: #0071e3;
      color: white;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2.5rem;
      }

      .content-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1.5rem;
      }

      .controls {
        flex-direction: column;
      }

      .control-group {
        width: 100%;
      }

      .control-btn {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="loading">Loading Matchflix...</div>
  </div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="authTitle">Welcome to Matchflix</h2>
        <p id="authSubtitle">Sign in to start finding your perfect watch</p>
      </div>

      <div id="authError" class="error-message hidden"></div>
      <div id="authSuccess" class="success-message hidden"></div>

      <!-- Login Form -->
      <form id="loginForm" class="hidden">
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" class="form-control" id="loginPassword" required>
        </div>
        <div style="text-align: right; margin-bottom: 1rem;">
          <a href="#" id="showForgotPassword" style="color: #0071e3; text-decoration: none; font-size: 0.9rem;">Forgot password?</a>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Sign In</button>
        </div>
        <div class="form-toggle">
          Don't have an account? <a href="#" id="showSignup">Sign up</a>
        </div>
      </form>

      <!-- Forgot Password Form -->
      <form id="forgotPasswordForm" class="hidden">
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="forgotPasswordEmail" required>
          <small style="color: #86868b; font-size: 0.8rem;">We'll send you a password reset link</small>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Send Reset Link</button>
          <button type="button" class="btn btn-secondary" id="backToLogin">Back to Login</button>
        </div>
      </form>

      <!-- Signup Form -->
      <form id="signupForm" class="hidden">
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="signupEmail" required>
        </div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-control" id="signupUsername" required pattern="[a-zA-Z0-9_]{3,20}">
          <small style="color: #86868b; font-size: 0.8rem;">3-20 characters, letters, numbers, and underscores only</small>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" class="form-control" id="signupPassword" required minlength="8">
          <small style="color: #86868b; font-size: 0.8rem; display: block; margin-top: 0.5rem;">
            Must contain:
            <ul style="margin: 0.25rem 0 0 1.25rem; padding: 0;">
              <li>At least 8 characters</li>
              <li>One uppercase letter</li>
              <li>One lowercase letter</li>
              <li>One number</li>
              <li>One special character (!@#$%^&*)</li>
            </ul>
          </small>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Sign Up</button>
        </div>
        <div class="form-toggle">
          Already have an account? <a href="#" id="showLogin">Sign in</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Friend Modal -->
  <div class="modal" id="friendModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Friends</h2>
        <p>Manage your friends and compare watch lists</p>
      </div>

      <div id="friendError" class="error-message hidden"></div>
      <div id="friendSuccess" class="success-message hidden"></div>

      <!-- Add Friend -->
      <div class="form-group">
        <label>Add Friend by Username</label>
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" class="form-control" id="addFriendUsername" placeholder="Enter username">
          <button class="btn btn-primary" onclick="sendFriendRequest()" style="white-space: nowrap;">Add</button>
        </div>
      </div>

      <!-- Friend Requests -->
      <div id="friendRequestsSection" class="friend-section hidden">
        <h3>Friend Requests</h3>
        <div id="friendRequestsList" class="friend-list"></div>
      </div>

      <!-- Friends List -->
      <div id="friendsSection" class="friend-section">
        <h3>Your Friends</h3>
        <div id="friendsList" class="friend-list"></div>
      </div>

      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeFriendModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Account Settings</h2>
        <p>Update your account information</p>
      </div>

      <div id="settingsError" class="error-message hidden"></div>
      <div id="settingsSuccess" class="success-message hidden"></div>

      <!-- Change Username -->
      <div class="form-group">
        <label>Change Username</label>
        <input type="text" class="form-control" id="newUsername" pattern="[a-zA-Z0-9_]{3,20}" placeholder="Enter new username">
        <small style="color: #86868b; font-size: 0.8rem;">3-20 characters, letters, numbers, and underscores only</small>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" onclick="changeUsername()">Update Username</button>
        <button class="btn btn-secondary" onclick="closeSettingsModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const TMDB_API_KEY = 'a781f5168ff3df908b3f1d4214ad0e6e';
    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
    const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';
    const SUPABASE_URL = 'https://kuskiynkppnodrdvdgmh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1c2tpeW5rcHBub2RyZHZkZ21oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3NjA5NzEsImV4cCI6MjA4MTMzNjk3MX0.dqa6DiXWez_EShAVxoothX9ekAlmKCaPw31v9jhu8KM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Global State
    let state = {
      user: null,
      movies: [],
      tvShows: [],
      activeTab: 'movies',
      viewMode: 'rate',
      category: 'trending',
      streamingProvider: 'all',
      searchQuery: '',
      ratings: {},
      ratedItems: {},
      friends: [],
      friendRequests: [],
      selectedFriends: [],
      loading: true,
      trailers: {},
      providers: {}
    };

    let itemsCache = {};

    // Initialize App
    async function init() {
      console.log('Init started');
      
      try {
        console.log('Getting current session with timeout');
        
        // Add a timeout wrapper
        const sessionPromise = supabase.auth.getSession();
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Session request timed out after 5s')), 5000)
        );
        
        let session = null;
        let error = null;
        
        try {
          const result = await Promise.race([sessionPromise, timeoutPromise]);
          session = result.data.session;
          error = result.error;
        } catch (timeoutError) {
          console.error('Timeout getting session:', timeoutError);
          // On timeout, just show login
          showAuthModal('login');
          document.getElementById('app').innerHTML = '';
          return;
        }
        
        console.log('Session result:', session, 'Error:', error);
        
        if (error) {
          console.error('Error getting session:', error);
          showAuthModal('login');
          document.getElementById('app').innerHTML = '';
          return;
        }
        
        if (!session || !session.user) {
          console.log('No session found, showing auth modal');
          showAuthModal('login');
          document.getElementById('app').innerHTML = '';
          return;
        }

        const user = session.user;
        console.log('User found from session:', user.id);

        console.log('Loading profile');
        await loadUserProfile(user);
        console.log('Profile loaded:', state.user);
        
        console.log('Loading ratings');
        await loadRatings();
        console.log('Ratings loaded');
        
        console.log('Loading friends');
        await loadFriends();
        console.log('Friends loaded');
        
        console.log('Fetching content');
        await fetchContent();
        console.log('Content fetched');
        
        console.log('Rendering app');
        renderApp();
        console.log('App rendered');
        
        console.log('Setting up event listeners');
        setupEventListeners();
        console.log('Init complete!');
        
      } catch (error) {
        console.error('Error in init:', error);
        document.getElementById('app').innerHTML = `
          <div class="error-message" style="max-width: 600px; margin: 4rem auto;">
            Error loading app: ${error.message}<br><br>
            <button class="btn btn-primary" onclick="window.location.reload()">Retry</button>
            <button class="btn btn-secondary" onclick="localStorage.clear(); window.location.reload()">Clear Cache & Retry</button>
          </div>
        `;
      }

      // Listen for auth state changes (for logout, etc.)
      supabase.auth.onAuthStateChange(async (event, session) => {
        console.log('Auth state changed:', event);
        
        if (event === 'SIGNED_OUT') {
          state.user = null;
          window.location.reload();
        }
      });
    }

    // Authentication
    async function loadUserProfile(authUser) {
      const { data: profile } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('auth_id', authUser.id)
        .single();

      state.user = profile;
    }

    function showAuthModal(mode) {
      const modal = document.getElementById('authModal');
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const forgotPasswordForm = document.getElementById('forgotPasswordForm');
      const title = document.getElementById('authTitle');
      const subtitle = document.getElementById('authSubtitle');
      
      // Hide all forms first
      loginForm.classList.add('hidden');
      signupForm.classList.add('hidden');
      forgotPasswordForm.classList.add('hidden');
      
      if (mode === 'login') {
        title.textContent = 'Welcome Back';
        subtitle.textContent = 'Sign in to continue';
        loginForm.classList.remove('hidden');
      } else if (mode === 'signup') {
        title.textContent = 'Create Account';
        subtitle.textContent = 'Join Matchflix and find your perfect watch';
        signupForm.classList.remove('hidden');
      } else if (mode === 'forgot') {
        title.textContent = 'Reset Password';
        subtitle.textContent = 'Enter your email to receive a reset link';
        forgotPasswordForm.classList.remove('hidden');
      }
      
      modal.classList.add('show');
    }

    document.getElementById('showSignup')?.addEventListener('click', (e) => {
      e.preventDefault();
      showAuthModal('signup');
    });

    document.getElementById('showLogin')?.addEventListener('click', (e) => {
      e.preventDefault();
      showAuthModal('login');
    });

    document.getElementById('showForgotPassword')?.addEventListener('click', (e) => {
      e.preventDefault();
      showAuthModal('forgot');
    });

    document.getElementById('backToLogin')?.addEventListener('click', (e) => {
      e.preventDefault();
      showAuthModal('login');
    });

    document.getElementById('forgotPasswordForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('forgotPasswordEmail').value;
      
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + window.location.pathname
      });
      
      if (error) {
        showAuthError(error.message);
      } else {
        showAuthSuccess('Password reset link sent! Check your email.');
        setTimeout(() => showAuthModal('login'), 3000);
      }
    });

    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      
      if (error) {
        showAuthError(error.message);
      } else {
        window.location.reload();
      }
    });

    document.getElementById('signupForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value;
      const username = document.getElementById('signupUsername').value;
      const password = document.getElementById('signupPassword').value;
      
      // Validate password requirements
      const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
      
      if (!passwordRegex.test(password)) {
        let errorMsg = 'Password must contain:\n';
        if (password.length < 8) errorMsg += '‚Ä¢ At least 8 characters\n';
        if (!/[a-z]/.test(password)) errorMsg += '‚Ä¢ One lowercase letter\n';
        if (!/[A-Z]/.test(password)) errorMsg += '‚Ä¢ One uppercase letter\n';
        if (!/\d/.test(password)) errorMsg += '‚Ä¢ One number\n';
        if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) errorMsg += '‚Ä¢ One special character\n';
        
        showAuthError(errorMsg.trim());
        return;
      }
      
      // Create auth user
      const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
      
      if (authError) {
        showAuthError(authError.message);
        return;
      }

      // Create profile
      const { error: profileError } = await supabase
        .from('user_profiles')
        .insert({
          auth_id: authData.user.id,
          username: username
        });

      if (profileError) {
        showAuthError(profileError.message);
        return;
      }

      // Create privacy settings
      await supabase
        .from('privacy_settings')
        .insert({
          user_id: authData.user.id,
          share_full_list: false,
          share_matches_only: true
        });

      showAuthSuccess('Account created! Please check your email to verify your account before signing in.');
      
      // Switch to login form after 3 seconds
      setTimeout(() => showAuthModal('login'), 3000);
    });

    function showAuthError(message) {
      const errorDiv = document.getElementById('authError');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    function showAuthSuccess(message) {
      const successDiv = document.getElementById('authSuccess');
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
      setTimeout(() => successDiv.classList.add('hidden'), 5000);
    }

    async function signOut() {
      await supabase.auth.signOut();
      window.location.reload();
    }

    // Load Data
    async function loadRatings() {
      console.log('Loading ratings for current user:', state.user.id);
      
      const { data } = await supabase
        .from('ratings')
        .select('*')
        .eq('user_id', state.user.id);

      console.log('Current user ratings loaded from DB:', data);

      state.ratings = {};
      state.ratedItems = {};

      data?.forEach(row => {
        const key = `${row.item_type}-${row.item_id}`;
        if (!state.ratings[key]) state.ratings[key] = {};
        state.ratings[key][state.user.id] = row.rating;
        if (row.item_data) state.ratedItems[key] = row.item_data;
      });

      console.log('State.ratings after loading current user:', state.ratings);

      // Load friend ratings if friends selected
      if (state.selectedFriends.length > 0) {
        await loadFriendRatings();
      }
    }

    async function loadFriendRatings() {
      const friendIds = state.selectedFriends.map(f => f.id);
      
      console.log('Loading ratings for friend IDs:', friendIds);
      
      const { data } = await supabase
        .from('ratings')
        .select('*')
        .in('user_id', friendIds);

      console.log('Friend ratings loaded from DB:', data);

      data?.forEach(row => {
        const key = `${row.item_type}-${row.item_id}`;
        if (!state.ratings[key]) state.ratings[key] = {};
        state.ratings[key][row.user_id] = row.rating;
        if (row.item_data && !state.ratedItems[key]) {
          state.ratedItems[key] = row.item_data;
        }
      });
      
      console.log('State.ratings after loading friend ratings:', state.ratings);
    }

    async function loadFriends() {
      // Load friends
      const { data: friendships } = await supabase
        .from('friendships')
        .select(`
          *,
          user:user_profiles!friendships_user_id_fkey(id, username),
          friend:user_profiles!friendships_friend_id_fkey(id, username)
        `)
        .or(`user_id.eq.${state.user.id},friend_id.eq.${state.user.id}`)
        .eq('status', 'accepted');

      state.friends = friendships?.map(f => 
        f.user_id === state.user.id ? f.friend : f.user
      ) || [];

      // Load friend requests
      const { data: requests } = await supabase
        .from('friendships')
        .select(`
          *,
          user:user_profiles!friendships_user_id_fkey(id, username)
        `)
        .eq('friend_id', state.user.id)
        .eq('status', 'pending');

      state.friendRequests = requests || [];
    }

    async function sendFriendRequest() {
      const username = document.getElementById('addFriendUsername').value.trim();
      if (!username) return;

      // Use ilike for case-insensitive search
      const { data: targetUser } = await supabase
        .from('user_profiles')
        .select('id')
        .ilike('username', username)
        .single();

      if (!targetUser) {
        showFriendError('User not found');
        return;
      }

      if (targetUser.id === state.user.id) {
        showFriendError("You can't add yourself");
        return;
      }

      const { error } = await supabase
        .from('friendships')
        .insert({
          user_id: state.user.id,
          friend_id: targetUser.id,
          status: 'pending'
        });

      if (error) {
        showFriendError(error.message);
      } else {
        showFriendSuccess('Friend request sent!');
        document.getElementById('addFriendUsername').value = '';
      }
    }

    async function respondToFriendRequest(requestId, accept) {
      await supabase
        .from('friendships')
        .update({ status: accept ? 'accepted' : 'declined' })
        .eq('id', requestId);

      await loadFriends();
      renderFriendModal();
    }

    async function removeFriend(friendId) {
      await supabase
        .from('friendships')
        .delete()
        .or(`and(user_id.eq.${state.user.id},friend_id.eq.${friendId}),and(user_id.eq.${friendId},friend_id.eq.${state.user.id})`);

      await loadFriends();
      renderFriendModal();
    }

    function showFriendError(message) {
      const errorDiv = document.getElementById('friendError');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 3000);
    }

    function showFriendSuccess(message) {
      const successDiv = document.getElementById('friendSuccess');
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
      setTimeout(() => successDiv.classList.add('hidden'), 3000);
    }

    function openFriendModal() {
      document.getElementById('friendModal').classList.add('show');
      renderFriendModal();
    }

    function closeFriendModal() {
      document.getElementById('friendModal').classList.remove('show');
    }

    // Settings Modal Functions
    function openSettingsModal() {
      document.getElementById('settingsModal').classList.add('show');
      document.getElementById('newUsername').value = '';
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    function showSettingsError(message) {
      const errorDiv = document.getElementById('settingsError');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    function showSettingsSuccess(message) {
      const successDiv = document.getElementById('settingsSuccess');
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
      setTimeout(() => successDiv.classList.add('hidden'), 3000);
    }

    async function changeUsername() {
      const newUsername = document.getElementById('newUsername').value.trim();
      
      if (!newUsername) {
        showSettingsError('Please enter a new username');
        return;
      }

      // Validate username format
      const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
      if (!usernameRegex.test(newUsername)) {
        showSettingsError('Username must be 3-20 characters (letters, numbers, underscores only)');
        return;
      }

      try {
        // Check if username is already taken
        const { data: existingUser } = await supabase
          .from('user_profiles')
          .select('id')
          .ilike('username', newUsername)
          .single();

        if (existingUser && existingUser.id !== state.user.id) {
          showSettingsError('Username is already taken');
          return;
        }

        // Update username
        const { error } = await supabase
          .from('user_profiles')
          .update({ username: newUsername })
          .eq('id', state.user.id);

        if (error) throw error;

        // Update local state
        state.user.username = newUsername;
        
        showSettingsSuccess('Username updated successfully!');
        
        // Refresh the app after 1 second to show new username everywhere
        setTimeout(() => {
          renderApp();
          closeSettingsModal();
        }, 1000);

      } catch (error) {
        console.error('Error updating username:', error);
        showSettingsError(error.message);
      }
    }

    function renderFriendModal() {
      // Render friend requests
      const requestsSection = document.getElementById('friendRequestsSection');
      const requestsList = document.getElementById('friendRequestsList');
      
      if (state.friendRequests.length > 0) {
        requestsSection.classList.remove('hidden');
        requestsList.innerHTML = state.friendRequests.map(req => `
          <div class="friend-item">
            <div class="friend-info">
              <div class="friend-avatar">${req.user.username[0].toUpperCase()}</div>
              <div class="friend-details">
                <div class="friend-name">@${req.user.username}</div>
              </div>
            </div>
            <div class="friend-actions">
              <button class="btn btn-primary btn-small" onclick="respondToFriendRequest('${req.id}', true)">Accept</button>
              <button class="btn btn-secondary btn-small" onclick="respondToFriendRequest('${req.id}', false)">Decline</button>
            </div>
          </div>
        `).join('');
      } else {
        requestsSection.classList.add('hidden');
      }

      // Render friends list
      const friendsList = document.getElementById('friendsList');
      if (state.friends.length > 0) {
        friendsList.innerHTML = state.friends.map(friend => `
          <div class="friend-item">
            <div class="friend-info">
              <div class="friend-avatar">${friend.username[0].toUpperCase()}</div>
              <div class="friend-details">
                <div class="friend-name">@${friend.username}</div>
              </div>
            </div>
            <div class="friend-actions">
              <button class="btn btn-secondary btn-small" onclick="removeFriend('${friend.id}')">Remove</button>
            </div>
          </div>
        `).join('');
      } else {
        friendsList.innerHTML = '<div style="text-align: center; color: #86868b; padding: 1rem;">No friends yet. Add some to compare lists!</div>';
      }
    }

    function toggleFriendSelection(friendId) {
      console.log('toggleFriendSelection called with friendId:', friendId);
      console.log('Current selectedFriends:', state.selectedFriends);
      console.log('All friends:', state.friends);
      
      const index = state.selectedFriends.findIndex(f => f.id === friendId);
      console.log('Friend index in selectedFriends:', index);
      
      if (index > -1) {
        console.log('Removing friend from selection');
        state.selectedFriends.splice(index, 1);
      } else {
        console.log('Adding friend to selection');
        const friend = state.friends.find(f => f.id === friendId);
        console.log('Found friend object:', friend);
        if (friend) state.selectedFriends.push(friend);
      }
      
      console.log('Updated selectedFriends:', state.selectedFriends);
      console.log('Loading friend ratings...');
      
      loadFriendRatings().then(() => {
        console.log('Friend ratings loaded, rendering app');
        renderApp();
      });
    }

    // Content Fetching
    async function fetchContent() {
      state.loading = true;
      
      const providerMap = {
        'all': '15|337|9|350|8|531|1899',
        'hulu': '15',
        'disney': '337',
        'prime': '9',
        'apple': '350',
        'netflix': '8',
        'paramount': '531',
        'max': '1899'
      };

      const providers = providerMap[state.streamingProvider];
      const region = 'US';

      try {
        let moviesUrl, tvUrl;

        if (state.searchQuery.trim()) {
          moviesUrl = `${TMDB_BASE_URL}/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(state.searchQuery)}`;
          tvUrl = `${TMDB_BASE_URL}/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(state.searchQuery)}`;
        } else if (state.category === 'trending') {
          moviesUrl = `${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&watch_region=${region}&with_watch_providers=${providers}&sort_by=popularity.desc`;
          tvUrl = `${TMDB_BASE_URL}/discover/tv?api_key=${TMDB_API_KEY}&watch_region=${region}&with_watch_providers=${providers}&sort_by=popularity.desc`;
        } else if (state.category === 'popular') {
          moviesUrl = `${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&watch_region=${region}&with_watch_providers=${providers}&sort_by=popularity.desc`;
          tvUrl = `${TMDB_BASE_URL}/discover/tv?api_key=${TMDB_API_KEY}&watch_region=${region}&with_watch_providers=${providers}&sort_by=popularity.desc`;
        } else if (state.category === 'top_rated') {
          moviesUrl = `${TMDB_BASE_URL}/discover/movie?api_key=${TMDB_API_KEY}&watch_region=${region}&with_watch_providers=${providers}&sort_by=vote_average.desc&vote_count.gte=1000`;
          tvUrl = `${TMDB_BASE_URL}/discover/tv?api_key=${TMDB_API_KEY}&watch_region=${region}&with_watch_providers=${providers}&sort_by=vote_average.desc&vote_count.gte=500`;
        }

        const [moviesRes, tvRes] = await Promise.all([
          fetch(moviesUrl),
          fetch(tvUrl)
        ]);

        const moviesData = await moviesRes.json();
        const tvData = await tvRes.json();

        state.movies = moviesData.results || [];
        state.tvShows = tvData.results || [];
      } catch (error) {
        console.error('Error fetching content:', error);
      }

      state.loading = false;
    }

    async function fetchTrailer(itemId, itemType) {
      const key = `${itemType}-${itemId}`;
      if (state.trailers[key]) return state.trailers[key];

      try {
        const res = await fetch(`${TMDB_BASE_URL}/${itemType}/${itemId}/videos?api_key=${TMDB_API_KEY}`);
        const data = await res.json();
        
        const trailer = data.results?.find(v => v.type === 'Trailer' && v.site === 'YouTube') ||
                       data.results?.find(v => v.type === 'Teaser' && v.site === 'YouTube');

        if (trailer) {
          state.trailers[key] = `https://www.youtube.com/watch?v=${trailer.key}`;
          return state.trailers[key];
        }
      } catch (error) {
        console.error('Error fetching trailer:', error);
      }
      
      return null;
    }

    async function fetchProviders(itemId, itemType) {
      const key = `${itemType}-${itemId}`;
      if (state.providers[key]) return state.providers[key];

      try {
        const res = await fetch(`${TMDB_BASE_URL}/${itemType}/${itemId}/watch/providers?api_key=${TMDB_API_KEY}`);
        const data = await res.json();
        
        const usProviders = data.results?.US?.flatrate || [];
        
        const providerMap = {
          15: 'Hulu',
          337: 'Disney+',
          9: 'Prime Video',
          350: 'Apple TV+',
          8: 'Netflix',
          531: 'Paramount+',
          1899: 'Max'
        };
        
        const available = usProviders
          .filter(p => providerMap[p.provider_id])
          .map(p => providerMap[p.provider_id]);
        
        state.providers[key] = available;
        return available;
      } catch (error) {
        console.error('Error fetching providers:', error);
      }
      
      return [];
    }

    // Rating Functions
    async function rateItem(itemId, itemType, interested) {
      const key = `${itemType}-${itemId}`;
      if (!state.ratings[key]) state.ratings[key] = {};
      
      // Toggle off if same rating
      if (state.ratings[key][state.user.id] === interested) {
        state.ratings[key][state.user.id] = null;
      } else {
        state.ratings[key][state.user.id] = interested;
      }
      
      // Save to Supabase
      const itemData = itemsCache[key] || null;
      await supabase
        .from('ratings')
        .upsert({
          user_id: state.user.id,
          item_id: itemId,
          item_type: itemType,
          rating: state.ratings[key][state.user.id],
          item_data: itemData,
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'user_id,item_id,item_type'
        });

      if (itemData) state.ratedItems[key] = itemData;
      
      renderApp();
    }

    function getItemRating(itemId, itemType) {
      return state.ratings[`${itemType}-${itemId}`] || {};
    }

    function getCurrentItems() {
      return state.activeTab === 'movies' ? state.movies : state.tvShows;
    }

    function getMatches() {
      console.log('=== GET MATCHES CALLED ===');
      console.log('state.selectedFriends:', state.selectedFriends);
      console.log('state.friends:', state.friends);
      
      const allItems = [...state.movies, ...state.tvShows];
      const compareIds = [state.user.id, ...state.selectedFriends.map(f => f.id)];
      
      console.log('Getting matches for user IDs:', compareIds);
      console.log('compareIds length:', compareIds.length);
      console.log('Total items to check:', allItems.length);
      console.log('Current user ID:', state.user.id);
      console.log('Selected friends:', state.selectedFriends.map(f => ({ id: f.id, username: f.username })));
      
      const matches = allItems.filter(item => {
        const itemType = item.title ? 'movie' : 'tv';
        const rating = getItemRating(item.id, itemType);
        
        console.log(`Checking ${item.title || item.name}:`, rating);
        console.log(`  - Rating object keys:`, Object.keys(rating));
        console.log(`  - Checking against IDs:`, compareIds);
        
        // Check if all selected users have rated it as interested
        // IMPORTANT: Must be explicitly true, not undefined/null/false
        const results = compareIds.map(userId => {
          const userRating = rating[userId];
          const hasRated = userRating === true;
          console.log(`    - User ${userId}: ${hasRated ? 'YES (interested)' : userRating === false ? 'NO (passed)' : 'NOT RATED (undefined)'}`);
          return hasRated;
        });
        
        // Only match if ALL users have explicitly rated as interested (true)
        const isMatch = compareIds.length > 0 && results.every(r => r === true);
        
        console.log(`  - Is match? ${isMatch} (all must be true: [${results.join(', ')}])`);
        
        if (isMatch) {
          console.log('‚úÖ MATCH FOUND:', item.title || item.name);
        }
        
        return isMatch;
      });
      
      console.log('Total matches found:', matches.length);
      return matches;
    }

    function getMyList() {
      const myRatedItems = [];
      
      for (const key in state.ratings) {
        const rating = state.ratings[key];
        if (rating[state.user.id] === true && state.ratedItems[key]) {
          myRatedItems.push(state.ratedItems[key]);
        }
      }
      
      // Also include items from current view
      const currentItems = [...state.movies, ...state.tvShows];
      currentItems.forEach(item => {
        const itemType = item.title ? 'movie' : 'tv';
        const key = `${itemType}-${item.id}`;
        const rating = getItemRating(item.id, itemType);
        
        if (rating[state.user.id] === true) {
          const alreadyIncluded = myRatedItems.some(i => {
            const iType = i.title ? 'movie' : 'tv';
            return iType === itemType && i.id === item.id;
          });
          
          if (!alreadyIncluded) {
            myRatedItems.push(item);
          }
        }
      });
      
      return myRatedItems;
    }

    function truncateToSentences(text, maxSentences = 2) {
      const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
      return sentences.slice(0, maxSentences).join(' ').trim();
    }

    // Rendering
    async function createContentCard(item) {
      const itemType = item.title ? 'movie' : 'tv';
      const key = `${itemType}-${item.id}`;
      
      itemsCache[key] = item;
      
      const rating = getItemRating(item.id, itemType);
      const title = item.title || item.name;
      const date = item.release_date || item.first_air_date;
      const year = date ? new Date(date).getFullYear() : '';
      
      // Check if it's a match
      const compareIds = [state.user.id, ...state.selectedFriends.map(f => f.id)];
      const isMatch = compareIds.length > 1 && compareIds.every(userId => rating[userId] === true);
      
      const trailerUrl = await fetchTrailer(item.id, itemType);
      const providers = await fetchProviders(item.id, itemType);

      return `
        <div class="content-card ${isMatch ? 'matched' : ''}">
          <div class="poster-container">
            ${item.poster_path 
              ? `<img src="${TMDB_IMAGE_BASE}${item.poster_path}" alt="${title}" class="poster">`
              : `<div class="poster-placeholder">${itemType === 'movie' ? 'üé¨' : 'üì∫'}</div>`
            }
            ${isMatch ? '<div class="match-badge">‚ú® Match!</div>' : ''}
          </div>
          
          <div class="content-info">
            <h3 class="content-title">${title}</h3>
            <div class="content-meta">
              <span class="year">${year}</span>
              ${item.vote_average > 0 ? `<span class="rating">‚≠ê ${item.vote_average.toFixed(1)}</span>` : ''}
            </div>
            ${item.overview ? `<p class="content-description">${truncateToSentences(item.overview, 2)}</p>` : ''}
            ${providers.length > 0 ? `
              <div class="streaming-badges">
                ${providers.map(p => `<span class="streaming-badge">${p}</span>`).join('')}
              </div>
            ` : ''}
            ${trailerUrl ? `<a href="${trailerUrl}" target="_blank" class="trailer-btn">‚ñ∂Ô∏è Watch Trailer</a>` : ''}
            
            ${state.viewMode === 'rate' ? `
              <div class="rating-buttons">
                <button 
                  onclick="rateItem(${item.id}, '${itemType}', false)"
                  class="rating-btn not-interested ${rating[state.user.id] === false ? 'active' : ''}"
                >
                  ‚úï Pass
                </button>
                <button 
                  onclick="rateItem(${item.id}, '${itemType}', true)"
                  class="rating-btn interested ${rating[state.user.id] === true ? 'active' : ''}"
                >
                  ‚ù§Ô∏è Interested
                </button>
              </div>
            ` : state.viewMode === 'mylist' ? `
              <div class="rating-buttons">
                <button 
                  onclick="rateItem(${item.id}, '${itemType}', true)"
                  class="rating-btn remove-btn"
                >
                  ‚úï Remove from My List
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    async function renderApp() {
      const app = document.getElementById('app');
      
      if (!state.user) return;

      let items = [];
      let emptyMessage = '';

      if (state.viewMode === 'rate') {
        items = getCurrentItems();
      } else if (state.viewMode === 'matches') {
        items = getMatches();
        const comparingWith = state.selectedFriends.length > 0 
          ? ` with ${state.selectedFriends.map(f => '@' + f.username).join(', ')}`
          : '';
        emptyMessage = `<div class="empty-state"><h3>No matches yet${comparingWith}</h3><p>Start rating content to find your perfect matches!</p></div>`;
      } else if (state.viewMode === 'mylist') {
        items = getMyList();
        emptyMessage = '<div class="empty-state"><h3>Your list is empty</h3><p>Mark some movies or shows as interested to build your list!</p></div>';
      }

      const cardPromises = items.map(item => createContentCard(item));
      const cards = await Promise.all(cardPromises);

      app.innerHTML = `
        <header>
          <h1>Matchflix</h1>
          <p class="tagline">Find something you'll both love to watch</p>
        </header>

        <div class="user-header">
          <div class="user-info">
            <div class="user-avatar">${state.user.username[0].toUpperCase()}</div>
            <div>
              <div style="font-weight: 600;">@${state.user.username}</div>
            </div>
          </div>
          <div style="display: flex; gap: 0.75rem;">
            <button class="btn btn-secondary" onclick="openSettingsModal()">Settings</button>
            <button class="btn btn-secondary" onclick="openFriendModal()">
              Friends ${state.friendRequests.length > 0 ? `(${state.friendRequests.length})` : ''}
            </button>
            <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
          </div>
        </div>

        ${state.selectedFriends.length > 0 || state.friends.length > 0 ? `
          <div class="friend-section">
            <h3>Compare With Friends</h3>
            <div class="friend-selector">
              ${state.friends.map(friend => `
                <div 
                  class="friend-chip ${state.selectedFriends.find(f => f.id === friend.id) ? 'selected' : ''}"
                  onclick="toggleFriendSelection('${friend.id}')"
                >
                  @${friend.username}
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <div class="search-container">
          <input 
            type="text" 
            class="search-bar" 
            id="searchBar"
            placeholder="üîç Search for movies and TV shows..."
            value="${state.searchQuery}"
          />
        </div>

        <div class="controls">
          <div class="control-group">
            <button class="control-btn ${state.viewMode === 'rate' ? 'active' : ''}" onclick="changeViewMode('rate')">
              Rate Content
            </button>
            <button class="control-btn ${state.viewMode === 'matches' ? 'active' : ''}" onclick="changeViewMode('matches')">
              ‚ú® Matches
            </button>
            <button class="control-btn ${state.viewMode === 'mylist' ? 'active' : ''}" onclick="changeViewMode('mylist')">
              My List
            </button>
          </div>

          ${state.viewMode === 'rate' ? `
            <div class="control-group">
              <button class="control-btn ${state.streamingProvider === 'all' ? 'active' : ''}" onclick="changeStreaming('all')">All Services</button>
              <button class="control-btn ${state.streamingProvider === 'hulu' ? 'active' : ''}" onclick="changeStreaming('hulu')">Hulu</button>
              <button class="control-btn ${state.streamingProvider === 'disney' ? 'active' : ''}" onclick="changeStreaming('disney')">Disney+</button>
              <button class="control-btn ${state.streamingProvider === 'prime' ? 'active' : ''}" onclick="changeStreaming('prime')">Prime</button>
              <button class="control-btn ${state.streamingProvider === 'apple' ? 'active' : ''}" onclick="changeStreaming('apple')">Apple TV+</button>
              <button class="control-btn ${state.streamingProvider === 'netflix' ? 'active' : ''}" onclick="changeStreaming('netflix')">Netflix</button>
              <button class="control-btn ${state.streamingProvider === 'paramount' ? 'active' : ''}" onclick="changeStreaming('paramount')">Paramount+</button>
              <button class="control-btn ${state.streamingProvider === 'max' ? 'active' : ''}" onclick="changeStreaming('max')">Max</button>
            </div>

            <div class="control-group">
              <button class="control-btn ${state.category === 'trending' ? 'active' : ''}" onclick="changeCategory('trending')">Trending</button>
              <button class="control-btn ${state.category === 'popular' ? 'active' : ''}" onclick="changeCategory('popular')">Popular</button>
              <button class="control-btn ${state.category === 'top_rated' ? 'active' : ''}" onclick="changeCategory('top_rated')">Top Rated</button>
            </div>

            <div class="control-group">
              <button class="control-btn ${state.activeTab === 'movies' ? 'active' : ''}" onclick="changeTab('movies')">üé¨ Movies</button>
              <button class="control-btn ${state.activeTab === 'tv' ? 'active' : ''}" onclick="changeTab('tv')">üì∫ TV Shows</button>
            </div>
          ` : ''}
        </div>

        ${state.loading ? '<div class="loading">Loading content...</div>' : 
          items.length === 0 && emptyMessage ? emptyMessage :
          `<div class="content-grid">${cards.join('')}</div>`
        }
      `;
    }

    function setupEventListeners() {
      const searchBar = document.getElementById('searchBar');
      let searchTimeout;
      
      searchBar?.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          state.searchQuery = e.target.value;
          fetchContent().then(() => renderApp());
        }, 500);
      });
    }

    function changeViewMode(mode) {
      state.viewMode = mode;
      renderApp();
    }

    function changeStreaming(provider) {
      state.streamingProvider = provider;
      fetchContent().then(() => renderApp());
    }

    function changeCategory(category) {
      state.category = category;
      fetchContent().then(() => renderApp());
    }

    function changeTab(tab) {
      state.activeTab = tab;
      renderApp();
    }

    // Start app
    init();
  </script>
</body>
</html>
